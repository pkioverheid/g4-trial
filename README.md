# Table of Contents

- [Overview](#overview)
- [Major changes from G3 to G4](#major-changes-from-g3-to-g4)
- [Certificate profiles](#certificate-profiles)
- [Limitations](#limitations)
- [Usage](#usage)
- [Requirements](#requirements)
- [Tested on](#tested-on)
- [Support](#support)
- [Contributing](#contributing)
- [Disclaimer](#disclaimer)

# Overview

The tools in this repository allow you to generate TRIAL (test) certificates for the PKIoverheid G4 hierarchies yourself. 
Use these certificates to test your own and relaying party's readiness for the production PKIoverheid G4 certificates issued by PKIoverheid TSPs. 

Some PKIoverheid TSPs offered TRIAL certificates for the G3 certificate hierarchy, however since them it was decided it is most effective for users to be able to generate their own test certificates. 

# Major changes from G3 to G4

There have been a number of changes from G3 to G4, which you need to be aware of.  

- Instead of one certificate root, the PKIoverheid G4 consists of multiple Certificate Roots, depending on its trust type (Public, Mandated (eIDAS) and Private). Since Privately trusted roots may be used separately within a specific domain, several Privately trusted Certificate roots are created. Relaying parties should only trust the appropriate certificate roots. Please see https://cert.pkioverheid.nl/ for details;
- Intermediate CAs are based upon Subject Type (Natural Persons, Legal Entities or Devices), rather than a validation type, for example Organisatie Persoon;
- G3 certificates used a limited number of Policy OIDs, this has been expanded significantly for the G4. This allows the relaying party to pinpoint exactly which type of certificate and validation was used. 
- G4 makes a distinction between Authenticity and Authentication certificates, while G3 only defined Authenticity for both use cases;
- Signature algorithm RSASSA‐PKCS1‐v1_5 has been designated as legacy by the SOG-IS Crypto Evaluation Scheme and is replaced by RSASSA-PSS. 

# Certificate profiles

The PKIoverheid G4 hierarchies offer many different types of certificates, each for a different purpose. Please refer to the factsheet [Wees voorbereid de nieuwe generatie pkioverheidcertificaten komen eraan](https://www.logius.nl/onze-dienstverlening/domeinen/toegang/pkioverheid/wees-voorbereid-de-nieuwe-generatie-pkioverheidcertificaten-komen-eraan) (Dutch) or [New generation of PKIoverheid Certificates](https://www.logius.nl/english/pkioverheid/new-generation-pkioverheid-certificates) (English) for details. 

Please be aware certificates generated by this tooling differ from their production counterparts in some aspects: 

- There is no Certificate Policy and as such these certificates provide no trust or whatsoever
- **Serial Numbers** used in PKIoverheid certificates should be between 12 octets and 20 octets in length. openSSL [hardcodes this length to 159 bits](https://github.com/openssl/openssl/blob/da8de0e8dd3e09655cd17ef700359c63acdc9cd4/apps/include/apps.h#L324). Additionally, the serial number is not generated using a CSPRNG.
- **Issuer** and **Subject** fields do not mention "Staat der Nederlanden", but "TRIAL PKIoverheid" instead. Nevertheless, relaying parties should not rely on Subject and Issuer for trust. 
- **crlDistributionPoints** point to `localhost` for TRIAL certificates by default, while for the Production environment these point to http://cert.pkioverheid.nl. CRL filenames are generated based on the Common Name of the CA certificates.  
- **Policy Identifiers** are defined by the [differentation model](https://oid.pkioverheid.nl/) and differ slightly between TRIAL and Production, for example: 

| Certificate type                      | TRIAL                             | Production                        |
|---------------------------------------|-----------------------------------|-----------------------------------|
| System Organization Validation Server | `2.16.528.1.1003.1.2.41.15.39.10` | `2.16.528.1.1003.1.2.44.15.39.10` | 

# Limitations

All G4 TRIAL certificates are self issued they must not be used for any production purpose and should only be used for testing purposes only.

# Usage

Setup the three layered CA hierarchy first:

```bash
bash create_ca.sh
```

Then create as many end entity certificates as you require. Use the `-n` flag to specify a unique Common Name. Any Subject Alternate Names can be added using the `-s` flag:

```bash
bash create_endentity.sh -n "End Entity 1" -s 'URI:www.test.com'
bash create_endentity.sh -n "End Entity 2" -s 'URI:www.test.com,URI:www.abc.nl'
```

Start a simple webserver to host the certificates (as specified in the `authorityInfoAccess` extension) and CRLs (as specified in the `crlDistributionPoints` extension) on the localhost.

```bash
bash start_server.sh
```

If you intend to host the certificates and CRLs on another domain use environment variables to modify. For example:

```bash
CRLURI=http://crl.example.com CERTURI=http://cert.example.com ./create_ca.sh 
```

# Requirements

- Any openSSL version > 3.0 should suffice

# Support & Contributing

These files are provided as-is and no warranty or support is given. However, you may create a Github issue to discuss issues and enhancements. 

# Disclaimer

This project is provided as-is, without any express or implied warranties, including but not limited to merchantability, fitness for a particular purpose, or non-infringement. Use generated self-signed certificate hierarchies is at your own risk, and the maintainers are not responsible for any security issues, misconfigurations, or unintended consequences. External systems, applications and entities must not trust certificates generated by this tooling. 
